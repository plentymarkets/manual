= Old online store: Klarna
:lang: en
include::{includedir}/_header.adoc[]
:keywords: Klarna, Klarna invoice, Klarna account, payment method
:description: Payment in plentymarkets: Set up the interface to Klarna in your plentymarkets system.
:position: 110

[IMPORTANT]
.Integration only for Callisto online stores
====
This page only contains instructions for integrating *Klarna* in Callisto online stores. The following instructions are not valid for Ceres online stores!
====

Klarna is Europe's leading provider for payment on invoice in online business. When you integrate Klarna, you can offer your customers the possibility of using an invoice as the payment method - and you can do so without risk for your customers or for your online store. Both payment methods, <<order-processing/payment/klarna#20, Klarna invoice>> and <<order-processing/payment/klarna#30, Klarna account>>, are only available for private customers in Germany, Austria and the Netherlands. Therefore, permit these payment methods only in <<crm/managing-contacts#15, customer classes>> for private customers.

[#10]
== Important notes

This chapter provides you with important information about integrating the payment provider in plentymarkets. If all of the settings were carried out correctly, then you can transfer information about shipped orders, (partial) returns and cancellations from plentymarkets to Klarna. The Klarna invoice will be saved directly in the order once the outgoing items have been booked.

Please pay attention to a few important notes in order to make processing Klarna orders as easy as possible:

*  You should always book the outgoing items and <<order-processing/payment/klarna#100, ship>> the items at the same time. This is because the 14 day payment deadline begins for your customer when the outgoing items are booked.
*  Klarna should be notified of <<order-processing/payment/klarna#100, returns>> as soon as possible in order to avoid dunning letters.
*  If the customer selects Klarna invoice as the payment method, then be sure to either send them an invoice via email or included in the package, depending on your own <<order-processing/payment/klarna#100, workflow>>. +
If the customer selects Klarna account, then do not send them an invoice. Klarna will group together all of the invoices and send the customer one multi-invoice at the end of the month.
*  If the customer <<order-processing/payment/klarna#100, cancels their order>>, then give it the status *cancelled* as soon as possible so that the shopping cart value will no longer be reserved for the customer.

[#20]
=== Payment on receipt of invoice

With *Klarna invoice*, your customers are able to shop easily because they only have to enter a few nonsensitive pieces of information instead of going through tedious registration processes. In addition, the customers only pay after receiving the items which makes shopping safer for them. In a survey that was carried out by the market research institute TNS Infratest, 59% of people who are rather inactive online shoppers stated the reason for this being that they prefer to pay after they have received the items. For further information about payment on invoice by Klarna, refer to the link:https://klarna.com/buy-klarna/our-services/klarna-invoice[Klarna invoice^] page.

.Info: Klarna payment on invoice
image::order-processing/payment/assets/EN-Payment-Methods-Klarna-01.png[]

[.subhead]
Order process

Once the order has been completed, the order will be sent to Klarna. As soon as Klarna gives positive feedback, the order will be saved. The customer will receive a confirmation message. If an error occurs or Klarna rejects the payment request, the order will not be saved. The customer will receive an error message in the order overview.

[#30]
=== Klarna account

The payment method *Klarna account* allows your customers to pay for their purchased items with monthly instalments. If you configure your online store layout appropriately, a note concerning <<order-processing/payment/klarna#180, instalment prices>> will be displayed in the *shopping cart/order process* as well as in the *item details*. The instalment price will automatically be calculated according to the invoice amount. This price will then be displayed in the order process. For further information about the payment Klarna account, refer to the link:https://klarna.com/buy-klarna/our-services/klarna-account[Klarna account^] page.

.Info: Klarna account
image::order-processing/payment/assets/EN-Payment-Methods-Klarna-02.png[]

[.subhead]
Order process

When selecting *Klarna account* as the payment method, the customer can directly see the intervals and the instalments. Once the order has been completed, the order will be sent to Klarna. As soon as Klarna gives positive feedback, the order will be saved and the customer will receive a confirmation message. If an error occurs or Klarna rejects the payment request, the order will not be saved and the customer will receive an error message in the order overview.

[#40]
=== Requirement for using Klarna in different countries

Klarna is available for the following countries:

* Germany
* Austria
* Netherlands
* Denmark
* Finland
* Norway
* Sweden

Before you save the Klarna access data for shipping to different countries, make sure that you set up the <<order-processing/payment/currencies#, currencies>> and <<omni-channel/online-store/setting-up-clients/multilingual-online-store#, languages>> in the online store.

[#50]
== Registering with Klarna

In order to register with Klarna, contact link:mailto:verkauf@klarna.com[Klarna] via email. You will receive the access data that you need for setting up Klarna in plentymarkets.

[#60]
== Setting up Klarna for Callisto

Proceed as described below to set up the interface to Klarna for your Callisto online store in plentymarkets. It is available for the payment methods *Klarna invoice* and *Klarna account*.

[.instruction]
Setting up the interface to Klarna:

. Go to *System » Orders » Payment » Methods*.
. Place a check mark next to the setting *Also show inactive*.
. Open the folder *International » Klarna*.
.  Click on *Klarna invoice* or *Klarna account*. +
→ The *Settings* tab will open.
. Click on the *Interface* tab.
.  Expand the client.
.  Carry out the settings as desired. Pay attention to the information given in <<table-setup-klarna-interface>>.
. *Save* the settings.

[[table-setup-klarna-interface]]
.setting up the interface to Klarna
[cols="1,3"]
|====
| Setting | Explanation

2+| Client (store) options

|*Activate access data for all clients (stores)*
|Option is only visible if clients (stores) were set up. +
*Yes* = The access data will be applied for all clients (stores), regardless of what is entered in the access data menus. +
*No* = The same access data can be entered for the default online store and for additional clients (stores). Alternatively, you can request separate access data for your clients (stores). +
Stores that do not have access data saved for them cannot be used with Klarna. +
Go to <<omni-channel/online-store/setting-up-clients/online-store#, System » Client » Select client » Online store » Settings>> and make sure that you have selected the option *Enable login for every store* in the line *Login*. This makes it possible to support several clients.

|*checkOrderStatus*
| Only for the payment method *Klarna invoice*. +
Click on the *gear-wheel icon* to manually check whether orders with a pending credit rating were approved. Besides, these orders will be checked on a daily basis.

|*Register with Klarna today*
| Link to the registration area in Klarna.

|*Free text field for the social security number*
| Select the free text field that was set up for entering the <<order-processing/payment/klarna#80, social security number>>. +
*_Important:_* Customers are required to enter a social security number for the countries Denmark, Finland, Norway and Sweden.

|*Default country*
|Select the default country. +
*_Important:_* In plentymarkets, Klarna is available for the <<fulfilment/preparing-the-shipment#100, countries of delivery>> Germany, Austria, the Netherlands, Denmark, Finland, Norway and Sweden. This means that only customers based in these countries can pay orders using Klarna.

|*eID; +
Shared secret*
|Enter the country-specific access data that you received from Klarna during the registration process.

|*Send invoice*
| Select the way of sending invoices. +
*Print invoice and enclose in package* = The invoice is printed and enclosed in the package by the seller. +
*Have Klarna send an invoice automatically via email* = Klarna will automatically send the invoice via email. It is no longer necessary to enclose the invoice in the package.

|*Update campaigns*
| For the *Klarna account* payment method only. +
Click on *Update campaigns* to update the table in the *Klarna campaigns* area.

|*Klarna campaigns*
| Overview with all information about your Klarna campaigns.
|====

[#70]
== Activating payment methods

For Klarna, the payment methods Klarna invoice and Klarna account are available. Go to <<order-processing/payment/managing-payment-methods#20, System » Orders » Payment » Payment methods>> to activate the payment methods. In addition, check the settings for *Permitted payment methods* in the <<order-processing/payment/managing-payment-methods#30, customer classes>> and for *Blocked payment methods* in the <<fulfilment/preparing-the-shipment#1000, shipping profiles>>.

[#80]
== Saving the social security number

Customers are required to enter a social security number for the countries Denmark, Finland, Norway and Sweden. You can make this mandatory field available for these countries by setting up a text field, which is displayed during the payment process.

[WARNING]
.No changes to the active design
====
Do not make changes to your active design. Before making changes to the design, make a backup copy so that you can restore the original state of the design.
====

[.instruction]
Setting up the text field:

. Go to *CMS » Web design*.
. Open the folder *Layout &gt; PageDesign*.
. Click on the template *PageDesignPrepareMainColumn*.
. Search for the variable *ShowInvoiceAddressPersonalId*.
. Change the value from *false* to *true*.
. *Save* the settings. +
→ The text field will be displayed under *Optional fields* during the payment process.

In order to change the name of the text field, proceed as follows.

[.instruction]
Changing the name of the text field:

. Go to *CMS » Web design*.
. Open the folder *Layout &gt; Checkout*.
. Click on the template *CheckoutCustomerInvoice*.
. Search for the variable *ShowInvoiceAddressPersonalId*.
. Replace the entry *Personal ID* in the *Label* tag of the code block with the desired name.
. *Save* the settings.

[#90]
== Automatically sending shipping confirmations

Set up the following event procedures in order to inform Klarna when items are shipped, orders and returns are cancelled and when invoices are created or deleted. Note that the event procedures also have to be created for Klarna account. Ask your contact person in the Klarna integration team to test the functionality before you start using the interface live. Set up an <<basics/automation/event-procedures#, event procedure>> to automatically send shipping confirmations when the outgoing items are booked.

[.collapseBox]
.Setting up an event procedure
--
.  Go to *System » Orders » Events*.
.  Click on *Add event procedure*. +
→ The *Create new event procedure* window will open.
.  Enter a name.
.  Select the *event* listed in <<table-event-procedure-automatic-shipping-confirmation-klarna>>.
. *Save* the settings.
.  Pay attention to the explanations given in <<table-event-procedure-automatic-shipping-confirmation-klarna>> and carry out the settings as desired.
.  Place a check mark next to the option *Active*.
. *Save* the settings.
--
[[table-event-procedure-automatic-shipping-confirmation-klarna]]
.Event procedure for sending automatic shipping confirmations to Klarna
[cols="1,3,3"]
|====
| Setting | Option | Selection

|*Event*
|*Order change: Outgoing items booked*
|

|*Filter 1*
|*Order &gt; Order type*
|*Order*

|*Filter 2*
|*Order &gt; Payment method*
|*Klarna account* +
*Klarna invoice payable within 14 days*

|*Procedure*
|*Shipping &gt; Send shipping confirmation to Klarna*
|
|====

If you want a status change to trigger when outgoing items are booked, then select the setting *Status change* as the event and then select the desired status.

[TIP]
.Tip
====
The shipping confirmation informs Klarna that the order was shipped. It then activates the invoice, which will automatically be saved in the order as a PDF file. If you need the invoice earlier, then select an earlier event. However, please make sure that the items will actually be shipped.
====

[#100]
== Automatically sending returns

Set up an <<basics/automation/event-procedures#, event procedure>> to automatically send returns to Klarna. For further information about creating returns, refer to the <<order-processing/orders/managing-sales-orders#return, Return>> page of the manual.

[.collapseBox]
.Setting up an event procedure
--
. Go to *System » Orders » Events*.
. Click on *Add event procedure*. +
→ The *Create new event procedure* window will open.
. Enter a name.
. Select the *event* listed in <<table-event-procedure-automatic-returns-klarna>>.
. *Save* the settings.
. Pay attention to the explanations given in <<table-event-procedure-automatic-returns-klarna>> and carry out the settings as desired.
. Place a check mark next to the option *Active*.
. *Save* the settings.
--
[[table-event-procedure-automatic-returns-klarna]]
.Event procedure for automatically sending returns to Klarna
[cols="1,3,3"]
|====
|Setting |Option |Selection

|*Event*
|*Order generation: New return (by customer)*
|

|*Filter 1*
|*Order &gt; Order type*
|*Return*

|*Filter 2*
|*Order &gt; Payment method*
|*Klarna account* +
*Klarna invoice payable within 14 days*

|*Procedure*
|*Return &gt; Send return to Klarna*
|
|====

[#110]
== Automatically sending cancellations

Set up an <<basics/automation/event-procedures#, event procedure>> to automatically inform Klarna of cancellations.

[.collapseBox]
.Setting up an event procedure
--
. Go to *System » Orders » Events*.
. Click on *Add event procedure*. +
→ The *Create new event procedure* window will open.
. Enter a name.
. Select the *event* listed in <<table-event-procedure-automatic-cancellations-klarna>>.
. *Save* the settings.
. Pay attention to the explanations given in <<table-event-procedure-automatic-cancellations-klarna>> and carry out the settings as desired.
. Place a check mark next to the option *Active*.
. *Save* the settings.
--
[[table-event-procedure-automatic-cancellations-klarna]]
.Event procedure for automatically sending cancellations to Klarna
[cols="1,3,3"]
|====
| Setting | Option | Selection

|*Event*
|*Order change: Status change*
| Select status for *cancelled orders*.

|*Filter 1*
|*Order &gt; Order type*
|*Order*

|*Filter 2*
|*Order &gt; Payment method*
|*Klarna account* +
*Klarna invoice payable within 14 days*

|*Procedure*
|*Order &gt; Delete Klarna invoice*
|
|====

[#120]
== Editing an order coming from Klarna

It is still possible to edit an order coming from Klarna until the outgoing items have been booked, e.g. reducing item quantity. It is also possible to delete items. The invoice amount will then be adjusted. You can only reduce the quantity, not increase it. You may not add further items to an existing order. Since no final invoice was created yet, it is not a problem to delete a Klarna order before the respective outgoing items are booked.

[.instruction]
Deleting an order:

. Go to *Orders » Edit orders*.
. Open the Klarna order. +
→ The *Overview* tab will open.
. Click on *Delete*. +
→ The order will be deleted.

[#130]
== Shipping items

Ship the items immediately since the customer's period of payment, which is 14 days, starts with the activation of the Klarna invoice. Note that the items may only be sent to the address that appears on the Klarna invoice. As soon as the outgoing items are booked, the invoice will be issued.

[IMPORTANT]
.Klarna orders will not be transferred to DHL Fulfillment
====
Currently, it is not possible to transfer orders that are paid with Klarna to <<fulfilment/preparing-the-shipment#4800, DHL Fulfillment>>. Only orders with a valid invoice can be transferred to DHL Fulfillment. However, Klarna only transmits the invoice to plentymarkets after outgoing items have been booked.
====

[#140]
=== Generating the Klarna invoice

As soon as the shipping confirmation was sent to Klarna or as soon as the outgoing items are booked, the system will create a Klarna invoice with the current data. The invoice will be made available as a PDF document via the *invoice number* link or in the order's *Receipts* tab. It can be printed out and enclosed in the package. Once the outgoing items have been booked, the invoice can also be attached to an email and automatically sent to the customer with the help of an event procedure.

[IMPORTANT]
.Invoice address cannot be changed
====
Please note that the (invoice) address cannot be changed. The invoice may not be deleted when the order is in status 7 (*outgoing items booked*).
====

[.instruction]
Downloading, printing and enclosing the invoice:

. In order to download the invoice, click on the invoice link directly in the *order overview*. Or open the order and click on the invoice link in the *Receipts* tab.
. Save the invoice and print it out afterwards.
. Put the invoice into the package.

[#150]
=== Manually importing a Klarna invoice

Upon receipt of the shipping confirmation, *Klarna* generates an invoice that is automatically linked to the respective order in your plentymarkets system.
However, it may occur that invoices belonging to orders with the payment method *Klarna* are not correctly importet into your plentymarkets system.

[TIP]
.Searching for orders with the payment method *Klarna*
====
Use the filter *Payment method* in the order search to identify and check orders with the payment method *Klarna*. If no *Invoice number* is displayed in the order overview, the import of Klarna invoices might have failed.
====

To manually import separate Klarna invoices into your plentymarkets system, log on to your Klarna account and select the required invoice. You can either store the invoice document on a server or save it on your local computer.

Then, proceed as follows to manually import the Klarna invoice.

[.instruction]
Manually importing a Klarna invoice

. Go to *System » Orders » Payment » Methods*.
. Open the payment method *Klarna*.
→ The tab *Interface* opens. +
. Carry out the settings according to <<table-klarna-invoice-import>>.
. Click on *Execute*. +
→ The Klarna invoice is imported and linked to the correct order. The Klarna invoice can be accessed in the *Receipts* tab of the order or by clicking on the *Invoice number* in the order overview.

[[table-klarna-invoice-import]]
.Settings in the *Interface* tab
[cols="1,3"]
|====
|*Order ID*
|Enter the ID of the order to which the invoice should be assigned.

|*Invoice-Url*
|If the invoice document is stored on a server, enter the document URL here.

|*Invoice number*
|Enter the invoice number as indicated on the Klarna invoice.

|*Klarna invoice PDF*
|If the invoice document is saved on your local computer, you can select the file here.

|*Invoice date*
|Enter the invoice date as indicated on the Klarna invoice.
|====

[#160]
=== Partial delivery

If the order changes or if one of the items is no longer available, then you can edit the items in the order. <<order-processing/payment/klarna#120, Edit the order>> before booking the outgoing items.

[#170]
=== Complete delivery

If an item is currently not available but it has been reordered, then wait for the reorder to arrive before booking the outgoing items.

[#180]
=== Pending orders

Pending orders are designated with *status 3* in the order overview.

In order to boost the rate of acceptance, orders that cannot be directly approved by Klarna will receive the status *Pending*. You can see these orders within the order overview. They are designated with *status 3*. Klarna will manually check the pending orders within the next few hours (maximum 24 hours). An integrated Cronjob is used to query the status of these orders at Klarna every hour. +
If the order is manually accepted during this process, then it will appear as a normal order. If the order is rejected, then it will be displayed as rejected. You can then offer the customer a different payment method.

The email that you use to offer the customer a different payment method should include a link to the checkout (template variable: [URL_Checkout]). Using this link, the customer will be able to select another payment method for the order.

[#190]
== Customising the template for instalment purchases

In order to display the instalment price on the item's page and in the list of items, the template *ItemViewSingleItem* has to be customised. You can also integrate the Klarna account logo into the display. For the Klarna logo, refer to the link:https://developers.klarna.com/en/se+php/kco-v2/logos[Klarna Developer Portal^].

[.instruction]
Customising the template for instalment purchases:

. Go to *CMS » Web design*.
. Open the folder *Layout » ItemView*.
. Click on the template *ItemViewSingleItem*.
. Insert the code example into the template.
. Replace the entry *SHOP-ID* with SHOP-ID that you received from Klarna. +
→ The SHOP-ID is also used in the plentymarkets back end for setting up the payment methods.
. *Save* the settings.

[.subhead]
Example code for displaying the instalment price

[source,plenty]
----
include::assets/EX-EN-Klarna-Installment.html[]

----
