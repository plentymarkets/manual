= Individual order process
:lang: en
// include::{includedir}/_header.adoc[]
:keywords: Individual order process, CMS, plentymarkets
:position: 15

The order process refers to the process that a customer goes through when buying something in the online store. It begins the moment a customer puts an item in their shopping cart and it continues until the moment that the order is sent. The individual order process is selected by default in *Callisto Light*. The individual order process gives you total control over what the order process looks like, how many functions it includes and how customers are guided through this process. You can define up to ten steps, which determine how customers will be led through the personalised order process. Additionally, you can customise the steps *Login*, *Logout*, *Customer registration*, *Forgot your password* and *Order confirmation*. +
This page of the manual teaches you how the individual order process is structured and which settings can be configured. +
The settings are carried out separately for each design and client (store). The number and content of the individual steps of the order process are also set for each client individually.

[IMPORTANT]
.Switching to the individual order process
====
Due to technical reasons, you will not be able to switch back to the default order process once you have already implemented the individual order process.
====

== Components of the individual order process in Callisto Light

The chapters *Categories*, *Order steps*, *The header "Purchase"* and *Additional pages* describe how the individual order process is structured.

=== Categories

The individual order process relies heavily on categories of the type <<item/managing-categories#, Container>>. This type of category can access all of the global template variables and functions that are used for the templates under *CMS » Web design » Layout » Checkout*. Conversely, global template variables and functions can be used to grant categories of the type *Container* access to template-specific variables and functions, i.e. non-global variables and functions. As such, the entire order process can be represented with categories. It is no longer absolutely necessary to use templates in the individual order process. The categories for Callisto Light are found in plentymarkets under *Item » Categories*. They are located in the web design's folder. There you can customise the content of the order steps. Use <<omni-channel/online-store/setting-up-clients/cms-syntax#web-design-pagedesign-link, link functions>> to create links from one category to another. You can use these previously defined functions:

.predefined template functions
[cols="1,3"]
|====
|Function call |Returned link

|*Link_CustomerRegistration()*
|Customer registration

|*Link_LostPassword()*
|Forgot your password

|*Link_OrderConfirmation()*
|Order confirmation

|*Link_Checkout(1)*
|Log in

|*Link_Checkout(2)*
|Shopping cart

|*Link_Checkout(3)*
|Purchase

|*Link_Checkout(4)*
|Order details

|*Link_Checkout(5)*
|Address

|*Link_Checkout(x)*
|x: order step number in the order process
|====


You can use anchor tags to link categories like *Customer registration* and *Order confirmation* anywhere in the order process.

[source,plenty]
----
include::assets/EX-EN-Individual-Order-Process-01.html[]

----

_Code example 1: code for the *Checkout* button_

Code example 1 is located in the *Shopping cart* category in Callisto Light. This code displays the *Checkout* button to customers (<<image-button-from-code-example>>). The code also checks whether the customer has already logged into the online store. If the customer is not logged in, then the function *Link_CustomerRegistration()* will be saved for the button's href attribute. The customer will be forwarded to the registration page after clicking on the *Checkout* button. Here, the customer can either log into the online store or create a new customer account. If the customer is already logged into the online store, then the link will lead to the *Order details* step, i.e. the link will lead to the first step of the *Purchase* header. This is because the template function *Link_Checkout(3)* was saved in the code.

[[image-button-from-code-example]]
.the *Checkout* button that is displayed with code example 1
image::omni-channel/online-store/setting-up-clients/_cms/web-design/editing-the-web-design/order-process/assets/EN-CMS-Individual-Order-Process-01.png[]

=== Order steps

Categories are linked to the eight order steps of the individual order process in *Callisto Light*. These links are saved in the <<omni-channel/online-store/cms#web-design-editing-the-web-design, design settings>> (<<image-predefined-order-steps-callisto>>).

Eight steps are saved for the order process in *Callisto Light*:

. Shopping cart
. Log in
. Purchase
. Order details
. Address
. Payment &amp; shipping
. Order overview &amp; transaction
. Order process

These eight steps are displayed with categories of the type *Container*. The categories for Callisto Light are found in plentymarkets under *Item » Categories*. They are located in the web design's folder. Two other order steps are also available (9th order process step and 10th order process step). It is possible to set up a total of ten order steps in the individual order process (<<image-predefined-order-steps-callisto>>). It is also possible to create five additional pages (<<image-predefined-order-steps-callisto>>).

[[image-predefined-order-steps-callisto]]
.predefined order steps in *Callisto Light*
image::omni-channel/online-store/setting-up-clients/_cms/web-design/editing-the-web-design/order-process/assets/EN-CMS-Individual-Order-Process-02.png[]

The following table lists the ten order steps that can be configured in the individual order process. Furthermore, the table explains the function of these steps in the front end, i.e. in the online store.

.order steps in the individual order process
[cols="1,3,3"]
|====
|No. |Step in the back end |Function in the front end

|*1*
|Shopping cart
|An overview of all the items that the customer wants to buy.

|*2*
|Log in
|The customer decides whether to proceed as a guest or as a registered user.

|*3*
|Purchase
a|Serves as the header for the following order steps (<<image-order-steps-category-purchase>>):
* Order details
* Address
* Payment &amp; shipping
* Overview &amp; contract closure

|*4*
|Order details
|Is displayed as the *Order details* tab in the front end. This tab is grouped under the heading *Purchase*.

|*5*
|Address
|Is displayed as the *Address* tab in the front end. This tab is grouped under the heading *Purchase*.

|*6*
|Payment &amp; shipping
|Is displayed as the *Payment &amp; shipping* tab in the front end. This tab is grouped under the heading *Purchase*.

|*7*
|Order overview &amp; transaction
|Is displayed as the *Overview &amp; contract closure* tab in the front end. This tab is grouped under the heading *Purchase*.

|*8*
|Order process
a|Allows the customer to choose where to go next:
* Shopping cart
* Purchase
* Log in

*Note:* This order step has the same name as the order process as a whole. The names are identical for technical reasons.

|*9*
|Free
|Not in use. Can be configured.

|*10*
|Free
|Not in use. Can be configured.
|====

=== The header "Purchase"

The third order step is the category *Purchase*. This category is a special case as it includes the four order steps described in <<table-order-steps-category-purchase>>. The category *Purchase* displays each of these four steps in succession. The purchase category is used to display a header and progress bar in the individual order process of *Callisto Light*. The progress bar shows customers which part of the order process they are currently completing (<<image-order-steps-category-purchase>>).

[[image-order-steps-category-purchase]]
.order steps of the category *Purchase*
image::omni-channel/online-store/setting-up-clients/_cms/web-design/editing-the-web-design/order-process/assets/EN-CMS-Individual-Order-Process-03.png[]

[[table-order-steps-category-purchase]]
.order steps in the header *Purchase*
[cols="1,3"]
|====
|Order steps of the category Purchase |Content

|*1. Order details*
a|Entry fields:
* Your reference
* Notes &amp; special requests
* Coupon codes

|*2. Address*
a|
* Invoice address
* Entry field for a differing delivery address

Optional fields:
* Fax
* Mobile
* PostNummer
* VAT number

|*3. Payment &amp; shipping*
a|
* Selection of payment methods
* Selection of shipping service providers

|*4. Overview &amp; contract closure*
a|
* Summary of the order
* Acceptance of terms and conditions
* Newsletter registration

|====


*Callisto Light* uses JavaScript to dynamically show and hide steps of the order process. Customers enter data while they complete the four order steps in the "Purchase" header (<<image-order-steps-category-purchase>>). REST calls are used in the background to exchange this data with the server and keep it up-to-date. The code for displaying the *Purchase* header is found in plentymarkets under *Item » Categories* when you open the folder for your design and click on the category *Purchase*.

The function *CategoryContentBody($_id)* loads the code for the four order steps in the category *Purchase*. It is easiest to find the order steps by searching for the HTML comments in the category.

.order steps in the category *Purchase*
[cols="1,3"]
|====
|Order process step |HTML comment

|*Order details*
|STEP 1: Order details

|*Address*
|STEP 2: Addresses

|*Payment &amp; shipping*
|STEP 3: Shipping &amp; Payment

|*Overview &amp; contract closure*
|STEP 4: Overview &amp; Confirmation
|====


Code example 2 shows how the content of the header *Purchase* is loaded in *Callisto Light* with the order steps *Order details*, *Address*, *Payment &amp; shipping* and *Overview &amp; contract closure*.

Code example 2 is located in the *Purchase* category and contains the order steps listed above. Line 7 of code example 2 includes the command *$_id= CheckoutStepPageID(4)*. This command saves the ID of the *Order details* step in the variable *$_id*. The number in parentheses after *CheckoutStepPageID* is the order step number that was saved in the design settings (<<image-predefined-order-steps-callisto>>). In this example, the variable *$_id* is given the category ID for the 4th order step. In <<image-predefined-order-steps-callisto>>, this is the ID 17464. In line 8, the attribute *data-plenty-checkout-content* is given the value that is saved in *$_id*. The code *data-plenty-checkout-content="$_id"* changes to *data-plenty-checkout-content="17464"*. The code *CategoryContentBody($_id)* in line 13 is used to access the content that was saved in the *Order details* category.

[source,plenty]
----
include::assets/EX-EN-Individual-Order-Process-02.html[]

----

_Code example 2: order steps of the category Purchase_

=== Additional pages

You can customise the following fives pages of the individual order process in addition to the ten order steps. These pages are also designed with categories:

* Login
* Logout
* Customer registration
* Forgot your password
* Order confirmation

== Content of the order steps

Global template functions load the HTML structure for individual order steps within the individual order process. These template functions provide the basic framework for displaying order data. By using REST calls, you can continuously transmit order data between the Client and the server. This ensures that data is up-to-date and consistent within the order steps.

The template *PageDesignPrepareMainColumn* specifies which elements should be loaded in the order steps.

=== HTML framework

The checkout templates display order data in the order steps. These templates are composed of HTML code, which structures the content of the order steps. The templates are found under *CMS » Web design » Layout » Checkout*. <<table-available-checkout-templates>> lists order steps along with the checkout templates that are used. For example, the order step *Shopping cart* uses the command *Container_CheckoutBasketItemsList()* to load the HTML framework for the item overview in the shopping cart. The template is found under *CMS » Web design » Layout » Checkout » CheckoutBasketItemsList*.

[[table-available-checkout-templates]]
.available checkout templates
[cols="1,3"]
|====
|Category |Container

|*Shopping cart*
|Container_CheckoutBasketItemsList() +
Container_CheckoutTotals() +
Container_CheckoutCoupon()

|*Order details*
|Container_CheckoutCoupon()

|*Address*
|Container_CheckoutCustomerInvoiceAddress() +
Container_CheckoutCustomerShippingAddress()

|*Payment &amp; shipping*
|Container_CheckoutMethodsOfPaymentList() +
Container_CheckoutShippingProfilesList()

|*Order overview &amp; transaction*
|Container_CheckoutMethodsOfPaymentList() +
Container_CheckoutShippingProfilesList()
|====


=== Loading individual elements

Global variables are defined in the template *PageDesignPrepareMainColumn* under *CMS » Web design » Layout » PageDesign*. These global variables are defined with the help of the template function <<omni-channel/online-store/setting-up-clients/cms-syntax#web-design-pagedesign-setglobal, setGlobal>>. This allows you to influence the visibility of elements, e.g. the entry fields for forms. Use the information under the comment *# CHECKOUT VALIDATION &amp; APPEARANCE* to specify how elements should be displayed in the individual order process (<<table-template-functions-order-details>>).

[[table-template-functions-order-details]]
.template functions for the order details
[cols="1,3,3"]
|====
|Function |Default value |Explanation

|*SetGlobal("ShowTabDetails", true);*
|true
|Displays the tab *Order details* in the header *Purchase*.

|*SetGlobal("ShowCustomerSign", true);*
|true
|Displays the entry field *Your reference*.

|*SetGlobal("ValidateCustomerSign", false);*
|false
|Validates the entry field *Your reference*.

|*SetGlobal("ShowCustomerNotice", true);*
|true
|Displays the entry field *Your notes &amp; special requests*.

|*SetGlobal("ShowCouponInDetails", true);*
|true
|Displays the entry field *Coupon code*.
|====


=== Displaying the payment methods

The global function *Container_CheckoutMethodsOfPaymentList* is found under *Item » Categories* when you open the folder for your design (e.g. callisto_light_3) and click on the category *Payment &amp; shipping*. This global function accesses the template *CheckoutMethodsOfPaymentList* under *CMS » Web design » Layout » Checkout*, which displays all of the available <<order-processing/payment/managing-payment-methods#, payment methods>>. It generates an HTML list with radio buttons, which customers can use to select a payment method (code example 3).

[source,plenty]
----
include::assets/EX-EN-Individual-Order-Process-03.html[]

----

_Code example 3: the template *CheckoutMethodsOfPaymentList*_

A change event is triggered when the payment method is selected. This event communicates with the server. The event uses the function call *plenty.CheckoutService.setMethodOfPayment* to transmit the payment method that was selected by the customer. The function is part of the *plentymarketsCMStools* and carries out the REST calls for the change event. The following code is part of the template *CheckoutMethodsOfPayment*. It displays the change event with the function call *plenty.CheckoutService.setMethodOfPayment*.

[source,plenty]
----
include::assets/EX-EN-Individual-Order-Process-04.html[]

----

_Code example 4: change event in the template *CheckoutMethodsOfPayment*_

== Validating the order data

The plentymarkets CMS validators make sure that your customers entered valid information during the order process. The server validates all of the data that customers entered before saving this data in the database. For example, it makes sure that email addresses have the correct format. It also makes sure that entry fields such as the street and house number use meaningful combinations of letters and numbers. The validators are found in your plentymarkets system under *CMS » Web design » Layout » Validator*. The following validators are relevant to the order process:

.validators for the order process
[cols="1,3"]
|====
|Validator template |Explanation

|*ValidatorCustomerInvoiceAddress*
|Validates the entries for the invoice address.

|*ValidatorCustomerShippingAddress*
|Validates the entries for the delivery address.

|*ValidatorPlaceOrder*
|Validates the entries for the last order step *Overview &amp; contract closure*.
|====


The template *ValidatorPlaceOrder* checks whether customers placed check marks next to the general terms and conditions, privacy policy or newsletter. The validator templates can be customised to specify which data should be checked and which messages should be displayed if errors occur. The following code checks whether the customer accepted the general terms and conditions by placing a check mark. If a check mark is placed, then the boolean *$TermsAndConditionsCheck* is set to the value 1. The call *AddError(16)* displays error code 16 if an error occurs, i.e. *$TermsAndConditionsCheck!= 1*.

[source,plenty]
----
include::assets/EX-EN-Individual-Order-Process-05.html[]

----

_Code example 5: the template *ValidatorPlaceOrder*_

[#10000]
== Setting up Google reCAPTCHA for the customer registration

Set up Google reCAPTCHA for the customer registration in your online store. First, register your online store to use link:https://www.google.com/recaptcha/admin#list[Google reCAPTCHA^]. Then, enter the website key and the secret key for your online store.

[.instruction]
Setting up Google reCAPTCHA:

. Go to *System » Client » Select client » Online store » Settings*.
. Select *Yes* under *Request Google reCAPTCHA in registration*.
. Enter the *Google reCAPTCHA Website key* ein.
. Enter the *Google reCAPTCHA Secret key*.
. *Save* the settings.

[#10010]
=== Editing the Registration category

Next add the template function `GetCaptcha()` as well as the following code example in the *Registration* category.

[TIP]
.Parameters for the GetCaptcha() function
====
The following parameters are available for the `GetCaptcha()` function:

- `GetCaptcha('normal')`: Default value for the normal Google reCAPTCHA.
- `GetCaptcha('compact')`: Parameter for the compact Google reCAPTCHA.
- `GetCaptcha('invisible')`: Parameter for the invisible Google reCAPTCHA.
====

[.instruction]
Editing the *Registration* category for normal or compact Google reCAPTCHA:

. Go to *Item » Categories*.
. Open the design’s folder, e.g. the folder for Callisto Light 3.
. Open the *Registration* category.
. Click on the *Description 1* tab.
. Insert the `{% GetCaptcha('normal') %}` or `{% GetCaptcha('compact') %}` template function above the *Register* button.
. Search for the code `plenty.AuthenticationService.registerCustomer();`.
. Replace the code with `registration();`.
. Search for `<script>`.
. Insert the following code example within the script area.
. *Save* the settings.

----
function registration(){
    var res = plenty.AuthenticationService.registerCustomer();

    if(typeof res !== 'undefined'){

        if(res.status == 400 && typeof grecaptcha !== 'undefined'){
            grecaptcha.reset();
        }

    }
    return false;
}
----

[.instruction]
Editing the *Registration* category for invisible Google reCAPTCHA:

. Go to *Item » Categories*.
. Open the design’s folder, e.g. the folder for Callisto Light 3.
. Open the *Registration* category.
. Click on the *Description 1* tab.
. Insert the `{% GetCaptcha('invisible') %}` template function above the *Register* button.
. Search for the code `plenty.AuthenticationService.registerCustomer();`.
. Replace the code with `grecaptcha.execute();`.
. Search for `<script>`.
. Insert the following code example within the script area.
. *Save* the settings.

----
function registration(){
    var res = plenty.AuthenticationService.registerCustomer();

    if(typeof res !== 'undefined'){

        if(res.status == 400 && typeof grecaptcha !== 'undefined'){
            grecaptcha.reset();
        }

    }
    return false;
}
----

[#10020]
== Setting up Google reCAPTCHA for guest orders

You can also set up Google reCAPTCHA for guest orders in your online store.

[#10030]
=== Editing CheckoutCustomerInvoiceAddress

Carry out the following changes in the *CheckoutCustomerInvoiceAddress* template first.

[.instruction]
Editing CheckoutCustomerInvoiceAddress for normal or compact Google reCAPTCHA:

. Go to *CMS » Web design » Layout » Checkout » CheckoutCustomerInvoiceAddress*.
. Search for `</form>`.
. Insert the `{% GetCaptcha('normal') %}` or `{% GetCaptcha('compact') %}` template function above the `</form>` tag.
. *Save* the settings.

[.instruction]
Editing CheckoutCustomerInvoiceAddress for invisible Google reCAPTCHA:

. Go to *CMS » Web design » Layout » Checkout » CheckoutCustomerInvoiceAddress*.
. Search for `</form>`.
. Insert the `{% GetCaptcha('invisible') %}` template function above the `</form>` tag.
. *Save* the settings.

[#10040]
=== Editing the Address category

Next, edit the *Address* category.

[.instruction]
Editing the *Address* category for normal or compact Google reCAPTCHA:

. Go to *Item » Categories*.
. Open the design’s folder, e.g. the folder for Callisto Light 3.
. Open the *Address* category.
. Click on the *Description 1* tab.
. Search for the code `plenty.CheckoutService.registerGuest().done(function()`.
. Replace the four lines of code with the following code example.
. *Save* the settings.

----
plenty.CheckoutService.registerGuest().done(function() {
    // change tab if success
    plenty.NavigatorService.continueChange( targetContainer );

    }).fail(function(){

    if(typeof grecaptcha !== 'undefined'){
        grecaptcha.reset();
    }

});
----

[.instruction]
Editing the *Address* category for invisible Google reCAPTCHA:

. Go to *Item » Categories*.
. Open the design’s folder, e.g. the folder for Callisto Light 3.
. Open the *Address* category.
. Click on the *Description 1* tab.
. Search for the code `plenty.CheckoutService.registerGuest().done(function()`.
. Replace the code with `grecaptcha.execute();`.
. Search for `<script>`.
. Insert the following code example within the script area.
. *Save* the settings.

----
function registration() {

    plenty.CheckoutService.registerGuest().done(function() {
    // change tab if success

        var targetContainer = {id:"shipping-payment", index:2};

        plenty.NavigatorService.continueChange(targetContainer);


    }).fail(function(){

        if(typeof grecaptcha !== 'undefined'){
            grecaptcha.reset();
        }

    });

}
----
