= Individuellen Bestellvorgang konfigurieren
:lang: de
// include::{includedir}/_header.adoc[]
:keywords: FormOpenCheckout, Container, Individueller Bestellvorgang
:position: 0

Der Bestellvorgang bezeichnet den Prozess des Kaufens im Webshop von dem Augenblick an, in dem der Kunde einen Artikel in den Warenkorb legt, bis zu dem Moment, in dem der Kunde die Bestellung abschickt. Der individuelle Bestellvorgang ermöglicht Ihnen die volle Kontrolle über das Aussehen, den Funktionsumfang und den Verlauf des Vorgangs. Sie können in bis zu 10 Schritten festlegen, wie ein Kunde Ihren persönlichen Bestellvorgang durchlaufen soll. Zusätzlich können Sie die Schritte *Login*, *Logout*, *Kundenregistrierung*, *Passwort vergessen* und *Bestellbestätigung* selbst gestalten. +
Auf dieser Seite wird Ihnen anhand des vorkonfigurierten individuellen Bestellvorgangs aus dem Standarddesign *Callisto Light* beschrieben, wie der individuelle Bestellvorgang aufgebaut ist und welche Techniken bei der Gestaltung eingesetzt wurden. Es wird also generell darauf eingegangen wie Anpassungen vorgenommen werden ohne eine konkrete Anpassung vorzunehmen.

== Voraussetzungen

Für die Beschreibungen wird Folgendes vorausgesetzt:

* Benutzung des Individuellen Bestellvorgangs
* Sicherer Umgang mit dem plentymarkets CMS
* Erfahrung mit der Einrichtung von Zahlungsdienstleistern (z.B. Paypal, Klarna, Payone)

== Kategorie-Typ: Container

Mit dem individuellen Bestellvorgang wurden Kategorien des Typs *Container* eingeführt. Kategorien dieses Typs besitzen die besondere Fähigkeit auf alle globalen Template-Variablen und Funktionen der Checkout-Templates aus dem Bereich *CMS » Webdesign » Checkout* zurückgreifen zu können. Dadurch ist es möglich den Bestellvorgang mithilfe von Kategorien abzubilden und dabei keinerlei Templates (beispielsweise CheckoutMethodsOfPaymentList) zu verwenden. Die benötigten Daten können über REST-Calls abgerufen werden. Die Kategorien Ihrer Bestellschritte müssen in den *Design-Einstellungen* eines Designs im Menü *CMS » Webdesign*hinterlegt werden. Eine kurze Einführung wie Sie die Kategorien hinterlegen, finden Sie unter <<webshop/webshop-einrichten/cms#webdesign-webdesign-bearbeiten-bestellvorgang-individueller-bestellvorgang, Individueller Bestellvorgang>> in unserem Handbuch.

////

Bis auf CheckoutPaymentInformation braucht man keinen Template-Container befüllen und kann alles über Kategorien organisieren. Checkout *Sheduler z.B. bei Abo *Total summen *AddressList sind die verfügbaren Adressen vom eingeloggten Kunden *suggestionList Adressvorschläge - hierfür wäre AddressDoctor interessant

////

== Aufbau des Individuellen Bestellvorgangs in Callisto Light

Im Standarddesign *Callisto Light* ist der Bestellvorgang in acht Schritte aufgeteilt. Diese acht Schritte sind Kategorien des Typs *Container.* Der erste Schritt ist der Warenkorb selbst, danach folgt die Anmeldung, in der Kunden entscheideen, ob sie als Gast zur Kasse gehen oder als registrierte Benutzer. Danach folgt der Schritt Kasse. Die Kategorie *Kasse* beinhaltet die nachfolgenden vier Bestellschritte und regelt die Abfolge dieser vier Bestellschritte. Die Kategorie *Kasse* wird im individuellen Bestellvorgang des Standarddesigns Callisto Light als Kopfzeile und Fortschrittsanzeige genutzt, anhand derer der Kunde sieht in welchem Schritt sich der Kunde befindet. Die 4 Bestellschritte, deren Abfolge in der Kategorie Kasse geregelt ist, sind die *Bestelldetails*, die *Anschrift*, der Schritt *Zahlung &amp; Versand* sowie die *Bestellübersicht &amp; Kaufabwicklung*. In den Bestelldetails werden beispielsweise Sonderwünsche oder Gutschein-Codes eingetragen. In den 2 anschließenden Schritten müssen die Rechnungs- und Versandadresse und die Auswahl der Zahlungs- und Versandart angegeben werden. Im letzten und abschließenden Schritt wird die Gesamtbestellung zusammengefasst. Der gesamte Vorgang besteht aus Kategorien des Typs *Container*, die hier eine entscheidende Rolle spielen, da nur Kategorien des Typs *Container* Zugriff auf die Template-Variablen und -Funktionen der Checkout-Templates haben. +
In den Design-Einstellungen, in denen Sie die Bestellschritte hinzufügen, geben Sie im Grunde auch schon eine Reihenfolge vor, aber in der Kategorie *Kasse* kann diese Reihenfolge noch einmal etwas variiert werden, indem hier die Bestellschritte in einer anderen Reihenfolge aufgerufen werden.

.Fortschrittsanzeige der Bestellschritte
image::webshop/webshop-einrichten/_cms-syntax/fallbeispiele/assets/DE-CMS-CheckoutIndicator.png[Fortschrittsanzeige der Bestellschritte]

=== Bestellschritte konfigurieren

Damit die oben abgebildete Fortschrittsanzeige der Bestellschritte in Ihrem Design korrekt arbeitet, müssen die Bestellschritte zunächst in den Design-Einstellungen konfiguriert werden.

. Wählen Sie im plentymarkets Administrationsbereich den Menüpunkt *CMS » Webdesign*
. Klicken Sie auf das Zahnrad (Einstellungen), um zu den Design-Einstellungen zu gelangen (neues Fenster)
. Wählen Sie nun *Tab:Mandanten* und wählen Sie in der linken Spalte einen Mandanten aus
. Wählen Sie in der rechten Seite *Tab:Bestellvorgang* um Bestellschritte zu konfigurieren

=== Bestellschritte verlinken

Im individuellen Bestellvorgang ist es möglich, neben den Bestellschritten, die Seiten für *Login*, *Logout*, *Kundenregistrierung*, *Passwort vergessen* und *Bestellbestätigung*, ebenfalls durch Kategorien, selbst zu gestalten. Kategorien eines Designs finden Sie im Menü *Artikel » Kategorien* im Ordner Ihres Designs. Um auf eine einzelne Kategorie zu verlinken, nutzen Sie die übliche Template-Funktion *Link($_CategoryId)* in Verbindung mit einem *a-Tag*. Für ausgewählte Bereiche gibt es spezielle vordefinierte Template-Funktionen, mit denen auf die hinterlegten Kategorien verwiesen werden kann.

////
Für Login z.B. Müsste man Funktion Link_Login() verwenden. Wenn leer bleibt, kommen die alten Methoden zum Einsatz die man nicht gestalten kann. Um z.B. eine Loginseite zu bauen, kann man restcall machen, in den man Pw und email steckt.
////

[.instruction]
Für ausgewählte Bereiche stehen Ihnen vordefinierte Template-Funktionen zur Verfügung:

.vordefinierte Template-Funktionen für Login, Logout, Kundenregistrierung, Passwort vergessen und Bestellbestätigung
[cols="1,3"]
|====
|Funktionsaufruf |Erläuterung

|*Link_CustomerRegistration()*
|Kundenregistrierung

|*Link_LostPassword()*
|Passwort vergessen

|*Link_OrderConfirmation()*
|Bestellbestätigung
|====


Folgendes Code-Beispiel kombiniert die Template-Funktionen *Link* und *Link_CustomerRegistration*

[source,plenty]
----
include::assets/EX-DE-Verlinkungen.html[]

----

=== Bestellschritte anzeigen

Im Standarddesign *Callisto Light* werden die Schritte des Bestellvorgangs durch JavaScript ein- und ausgeblendet. Das Laden der Inhalte geschieht bereits wenn die Seite durch den Funktionsaufruf *CategoryContentBody($_CategoryId)* aufgerufen wird. Die Sichtbarkeit der Container-Kategorien wird durch die *plentymarketsCMSTools* über das individuelle Attribut *data-plenty-checkout-id* geregelt, dem die ID des anzuzeigenden Inhalt übergeben wird. +
Das untenstehende Code-Beispiel zeigt, wie der Inhalt der Kategorien im Callisto Light Design geladen wird.

[source,plenty]
----
include::assets/EX-DE-Anzeigelogik-Tabs.html[]

----

=== Zu Bestellschritten springen

Wenn Sie in den *Design-Einstellungen* unter *Tab:Mandanten » Tab:Bestellvorgang* Ihre Bestellschritte hinzugefügt haben, ist eine Möglichkeit durch die Bestellschritte zu navigieren, indem Sie in Ihren Kategorien die Template-Funktion *FormOpenCheckout($_htmlID, true)* verwenden. Der Aufruf dieser Template-Funktion beginnt den inkrementellen Durchlauf der im Bestellvorgang hinterlegten Kategorien. +
Der erste Parameter der Template-Funktion steht für die ID eines klickbaren Elements. Im zweiten Parameter wird angegeben, ob beim Klick des Elements zum nächsten Schritt des Bestellvorgangs gesprungen werden oder der aktive Schritt neu geladen werden soll. Wenn Sie den Wert *true* eintragen, lädt der Folgeschritt des Bestellvorgangs, während *false* einen Seiten-Reload der aktuellen Seite verursacht.

Code-Beispiel für die Benutzung der Template-Funktion *FormOpenCheckout()*

[source,plenty]
----
include::assets/EX-DE-FormOpenCheckout.html[]

----

=== Bestellschritte mithilfe der plentymarketsCMSTools wechseln

Das Standarddesign *Callisto Light* setzt verstärkt auf den Einsatz des Scripts link:https://github.com/plentymarkets/plenty-cms-library[plentymarketsCMSTools.js^]. Das Script ist ein Opensource-Projekt von *plentymarkets* und kann auf GitHub.com geklont und nach Belieben manipuliert werden. +
Im individuellen Bestellvorgang wird über das individuelle Attribut *data-plenty-checkout-href* die Schaltfläche *Weiter* mit einer Direktive der plentymarketsCMSTools verbunden. Die Direktive inkrementiert den Index der die Sichtbarkeit der Kategorien des Bestellvorgangs regelt.

== Zahlungsdienstleister einbinden

Dienstleister wie Klarna, Paypal oder Amazon Payment verwenden verschiedene Verfahren, um Kaufabwicklungen zu ermöglichen. In einigen Fällen wird ein IFrame eingebunden und in anderen Fällen zur Seite des Dienstleisters weitergeleitet. Das plentymarkets CMS stellt Ihnen Template-Variablen und -Funktionen zur Verfügung, die es Ihnen einfach machen, den jeweiligen Dienstleister für Ihre Kunden bereit zu stellen. Wenn Sie in Ihrem plentymarkets System unter *System » Systemeinstellungen » Aufträge » Zahlung » Zahlungsarten* einen Zahlungsdienstleister (z.B. Klarna) konfiguriert haben, können Sie die Template-Variable oder -Funktion für die entsprechende Zahlungsart verwenden.

////
PaymentInformation: PreparePayment muss erfolgen für -&gt; MethodOfPaymentId muss erstmal über rest übergeben werden. Möglichkeiten die vom Server zurück kommen: 1. Zahlungsarten können redirect zurückgenben, dann muss weiterleitung erfolgen 2. Addition COntent (z.b. iframe) 3. Es kommt nichts zurück, man kommt direkt weiter (z.b. Nachnahme) ChechoutPrepareBacklinkUrl sagt z.b. Paypal, wo er hinspringen soll, wenn Paypal mit dessen Zahlungsgedöns fertig ist. Um einen Auftrag anzulegen muss ich PlaceOrder ausführen. Sollte immer gesetzt werden: Wo soll ich hinspringen wenn bei der weiterleitung fertig ist. Es muss eine primäre URL für die Zahlungsarten geben, weil Dienstleister das teilweise brauchen. D.h., wenn ich die Zahlungsarten auf verschiedene Seiten aufgeteilt habe, muss ich eine davon als primäre Seite deklarieren. PaymentInfromation: Contetn ist der gesamte Rahmen InformationFrame ist, wie son payment aussehen soll Formular für Bankinformation kann man in *Details verwenden PaymentInformation sollten immer befüllt werden -&gt; nicht mit Kategorie Container verwendbar KreditCardInfo fliegt raus nicht in Doku erwähnen
////

=== Zahlungsarten grundlegend einrichten

Einige Einstellungen sind für jede Zahlungsart gleich und haben zunächst nicht unmittelbar mit der Anzeige im Webshop zu tun. So müssen für jede Zahlungsart Zugangsdaten eingetragen und festgelegt werden, ob die Zahlungsart generell aktiv ist, unter welchen Namen die Zahlungsart angezeigt werden soll, für welche Lieferländer die Zahlungsart erlaubt ist und für welchen Mandanten die Zahlungsart gilt. Je nach Dienstleister sind im Tab *Schnittstelle* unter *System » Systemeinstellungen » Aufträge » Zahlung » Zahlungsarten* weitere Einstellungen notwendig. +
Falls Ihnen im ersten Moment keine Zahlungsarten angezeigt werden, achten Sie bitte darauf, dass das Feld *Auch inaktive anzeigen* im unteren Bereich der Seite aktiviert ist.

.Einstellungen der Zahlungsarten
image::webshop/webshop-einrichten/_cms-syntax/fallbeispiele/assets/DE-CMS-Zahlungsarten.png[Einstellungen der Zahlungsarten]

=== Zahlungsart übertragen

////
  Mit Template MethodsOfPayment beginnen
////

Um alle verfügbaren Zahlungsarten auszugeben, wird in *Callisto Light* das Template *CheckoutMethodsOfPayment* verwendet. Im Template wird eine Liste aus Input-Feldern des Typs *radio* erzeugt. +
Ein OnChange-Event sorgt für die Kommunikation mit dem Server und überträgt die vom Benutzer ausgewählte Zahlungsart, durch den Funktionsaufruf *plenty.CheckoutService.setMethodOfPayment()*. Die Funktion gehört zu den plentymarketsCMStools und führt die nötigen REST-Calls für diese Operation aus.

Der folgende Code ist ein Ausschnitt des Template *CheckoutMethodsOfPayment* und zeigt das OnChange-Event:

[source,plenty]
----
include::assets/EX-DE-OnChange-Event.html[]

----

== Bestelldaten durch Validatoren prüfen

Mit den Validatoren des plentymarkets CMS können Sie die Eingaben Ihrer Kunden im Bestellprozess auf Richtigkeit überprüfen. Alle eingegebenen Daten werden vom Server validiert, bevor die Daten in der Datenbank abgelegt werden. Beispielsweise werden E-Mail-Adressen auf Richtigkeit ihres Formats untersucht oder Eingabefelder wie Straße und Hausnummer auf sinnvolle Ziffern- oder Buchstabenfolgen geprüft. +
Die Validatoren finden Sie in Ihrem plentymarkets System unter *CMS » Webdesign » Layout » Validator*.

[.instruction]
Folgende Validatoren sind für den Bestellvorgang wichtig:

.Wichtige Validatoren für den Bestellvorgang
[cols="1,3"]
|====
|Validator-Templatenamen |Erläuterung

|*ValidatorCustomerInvoiceAddress*
|Validiert die Eingaben für die Rechnungsadresse.

|*ValidatorCustomerShippingAddress*
|Validiert die Eingaben für die Lieferanschrift

|*ValidatorPlaceOrder*
|Validiert die Eingaben für den letzten Bestellschritt "Übersicht &amp; Vertragsabschluss"
|====


Im Template *ValidatorPlaceOrder* wird unter anderem geprüft, ob Checkboxen für AGB, Datenschutzerklärung oder Newsletter gesetzt sind. In den Templates der Validatoren kann eingestellt werden, welche Daten überprüft werden sollen und welche Meldungen im Fehlerfall angezeigt werden müssen. Nachfolgender Code prüft, ob die AGBs (Terms and Conditions) vom Benutzer akzeptiert wurden bzw. ob die Checkbox angehakt (gecheckt) wurde. Mit dem Aufruf *AddError(16)* wird dafür gesorgt, dass im Fehlerfall eine Meldung mit dem Fehlercode 16 ausgegeben wird.
[source,plenty]
----
include::assets/EX-DE-Validatoren.html[]

----

////
h2>Fehlt noch</h2>
<ul>
<li>Infografik, wie Kategorien + Tools + alles miteinander arbeiten</li>
</ul
////
